# Docker æ„å»ºè¯´æ˜

## æ¦‚è¿°

ä¸ºäº†ä¼˜åŒ–æ„å»ºæ•ˆç‡å’Œè§£å†³ä¾èµ–ç¼–è¯‘é—®é¢˜ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†åˆ†ç¦»å¼æ„å»ºæ¶æ„ï¼š

1. **Builder é•œåƒ** (`dockerfile.dev`)ï¼šåŒ…å«ç¼–è¯‘å·¥å…·å’Œé¢„æ„å»ºçš„ Python ä¾èµ–
2. **åº”ç”¨é•œåƒ** (ä¸» `Dockerfile`)ï¼šåŸºäº Builder é•œåƒï¼Œåˆ›å»ºè½»é‡çº§è¿è¡Œæ—¶é•œåƒ

## æ¶æ„ä¼˜åŠ¿

- **è§£å†³ç¼–è¯‘é—®é¢˜**ï¼špyaudio ç­‰éœ€è¦ C æ‰©å±•çš„åŒ…åœ¨ builder é˜¶æ®µé¢„ç¼–è¯‘
- **å‡å°‘é•œåƒå¤§å°**ï¼šæœ€ç»ˆåº”ç”¨é•œåƒä¸åŒ…å«ç¼–è¯‘å·¥å…·ï¼Œæ›´è½»é‡
- **æé«˜æ„å»ºæ•ˆç‡**ï¼šä¾èµ–å˜æ›´æ—¶æ‰é‡å»º builderï¼Œä»£ç å˜æ›´ç›´æ¥ä½¿ç”¨é¢„æ„å»ºä¾èµ–
- **æ”¯æŒå¤šæ¶æ„**ï¼šè‡ªåŠ¨æ„å»º amd64 å’Œ arm64 é•œåƒ

## GitHub Actions è‡ªåŠ¨åŒ–

### ğŸ”§ Builder é•œåƒæ„å»º (docker-build-builder.yml)

**è§¦å‘æ¡ä»¶ï¼š** åªæœ‰å½“ä»¥ä¸‹æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šæ„å»º builder é•œåƒ

- `docker/dockerfile.dev`
- `pyproject.toml`
- `uv.lock`
- `.github/workflows/docker-build-builder.yml`

**æ„å»ºç›®æ ‡ï¼š** ä½¿ç”¨ `--target builder` åªæ„å»ºç¬¬ä¸€é˜¶æ®µï¼ˆç¼–è¯‘é˜¶æ®µï¼‰

**é•œåƒå‘½åï¼š** `ghcr.io/{repository}-builder:latest`

**åŒ…å«å†…å®¹ï¼š**

- ç¼–è¯‘å·¥å…· (gcc, g++, libc6-dev)
- éŸ³é¢‘å¤„ç†å¼€å‘åº“ (portaudio19-dev, libasound2-dev)
- é¢„æ„å»ºçš„ Python è™šæ‹Ÿç¯å¢ƒ (`/opt/venv`)

### ğŸš€ åº”ç”¨é•œåƒæ„å»º (docker-build-app.yml)

**è§¦å‘æ¡ä»¶ï¼š** åº”ç”¨ä»£ç å˜æ›´æ—¶è§¦å‘

- `Dockerfile`
- `main.py`
- `bailing/**`
- `config/**`
- `plugins/**`
- `server/**`
- `.github/workflows/docker-build-app.yml`

**æ„å»ºè¿‡ç¨‹ï¼š**

1. ä½¿ç”¨ builder é•œåƒä½œä¸ºä¾èµ–æº
2. åˆ›å»ºè½»é‡çº§è¿è¡Œæ—¶åŸºç¡€é•œåƒ
3. ä» builder å¤åˆ¶é¢„æ„å»ºçš„è™šæ‹Ÿç¯å¢ƒ
4. æ·»åŠ åº”ç”¨ä»£ç å’Œè¿è¡Œæ—¶é…ç½®

**é•œåƒç‰¹ç‚¹ï¼š**

- åŸºäº bookworm-slimï¼Œä½“ç§¯æ›´å°
- åªåŒ…å«è¿è¡Œæ—¶åº“ï¼Œä¸å«ç¼–è¯‘å·¥å…·
- è‡ªåŠ¨åˆ›å»ºé root ç”¨æˆ·è¿è¡Œ

## æœ¬åœ°æ„å»ºæ­¥éª¤

### 1. æ„å»º Builder é•œåƒ

```bash
# æ„å»º builder é•œåƒï¼ˆåªæ„å»º builder é˜¶æ®µï¼‰
docker build -f docker/dockerfile.dev --target builder -t bailing-builder:latest .

# æ¨é€åˆ°æ³¨å†Œè¡¨
docker build -f docker/dockerfile.dev --target builder -t ghcr.io/your-username/bailing-builder:latest .
docker push ghcr.io/your-username/bailing-builder:latest
```

**æ³¨æ„ï¼š** å¿…é¡»ä½¿ç”¨ `--target builder` å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦ç¬¬ä¸€é˜¶æ®µçš„å†…å®¹

### 2. æ„å»ºåº”ç”¨é•œåƒ

```bash
# ä½¿ç”¨æœ¬åœ° builder é•œåƒ
docker build --build-arg BUILDER_IMAGE=bailing-builder:latest -t bailing:latest .

# ä½¿ç”¨æ³¨å†Œè¡¨ä¸­çš„ builder é•œåƒï¼ˆé»˜è®¤ï¼‰
docker build -t bailing:latest .

# æŒ‡å®šç‰¹å®šçš„ builder é•œåƒ
docker build --build-arg BUILDER_IMAGE=ghcr.io/your-username/bailing-builder:latest -t bailing:latest .
```

**è¯´æ˜ï¼š** åº”ç”¨é•œåƒä¼šè‡ªåŠ¨ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œä» builder é•œåƒå¤åˆ¶é¢„æ„å»ºçš„ä¾èµ–

## å·¥ä½œæµç¨‹ä¼˜åŠ¿

1. **è§£å†³ç¼–è¯‘é—®é¢˜**ï¼špyaudio ç­‰ C æ‰©å±•åŒ…åœ¨æœ‰ç¼–è¯‘å·¥å…·çš„ builder é˜¶æ®µé¢„ç¼–è¯‘
2. **æ™ºèƒ½è§¦å‘**ï¼šåªæœ‰ä¾èµ–å˜åŒ–æ—¶æ‰é‡æ–°æ„å»º builder é•œåƒ
3. **å‡å°‘æ„å»ºæ—¶é—´**ï¼šåº”ç”¨ä»£ç å˜æ›´æ—¶ï¼Œç›´æ¥ä½¿ç”¨é¢„æ„å»ºä¾èµ–
4. **é•œåƒä½“ç§¯ä¼˜åŒ–**ï¼šæœ€ç»ˆåº”ç”¨é•œåƒä¸åŒ…å«ç¼–è¯‘å·¥å…·ï¼Œæ›´è½»é‡
5. **å¤šæ¶æ„æ”¯æŒ**ï¼šè‡ªåŠ¨æ„å»º linux/amd64 å’Œ linux/arm64
6. **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šGitHub Actions è‡ªåŠ¨å¤„ç†é•œåƒæ„å»ºå’Œæ¨é€
7. **ç¼“å­˜ä¼˜åŒ–**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç‹¬ç«‹çš„ç¼“å­˜ä½œç”¨åŸŸ

## æ–‡ä»¶è¯´æ˜

- `docker/dockerfile.dev`ï¼šBuilder é•œåƒçš„ Dockerfileï¼ŒåªåŒ…å«ç¼–è¯‘é˜¶æ®µ
- `Dockerfile`ï¼šåº”ç”¨é•œåƒçš„ Dockerfileï¼ŒåŸºäº builder é•œåƒåˆ›å»ºè¿è¡Œæ—¶é•œåƒ
- `.github/workflows/docker-build-builder.yml`ï¼šBuilder é•œåƒæ„å»ºå·¥ä½œæµ
- `.github/workflows/docker-build-app.yml`ï¼šåº”ç”¨é•œåƒæ„å»ºå·¥ä½œæµ

## å…³é”®æŠ€æœ¯ç‚¹

### Builder é˜¶æ®µè®¾è®¡

- ä½¿ç”¨ `python3.11-bookworm` ä½œä¸ºåŸºç¡€é•œåƒï¼ŒåŒ…å«å®Œæ•´ç¼–è¯‘ç¯å¢ƒ
- å®‰è£… `portaudio19-dev`ã€`libasound2-dev` ç­‰éŸ³é¢‘å¤„ç†å¼€å‘åº“
- åˆ›å»ºè™šæ‹Ÿç¯å¢ƒåœ¨ `/opt/venv`ï¼Œé¢„ç¼–è¯‘æ‰€æœ‰ Python ä¾èµ–
- ç‰¹åˆ«è§£å†³äº† `pyaudio==0.2.14` çš„ç¼–è¯‘é—®é¢˜

### åº”ç”¨é˜¶æ®µè®¾è®¡

- ä½¿ç”¨ `python3.11-bookworm-slim` è½»é‡çº§åŸºç¡€é•œåƒ
- åªå®‰è£…è¿è¡Œæ—¶å¿…éœ€çš„åº“ï¼ˆå¦‚ `libportaudio2`ã€`libasound2`ï¼‰
- ä» builder é˜¶æ®µå¤åˆ¶é¢„æ„å»ºçš„è™šæ‹Ÿç¯å¢ƒ
- åˆ›å»ºé root ç”¨æˆ· `appuser` æé«˜å®‰å…¨æ€§

## é•œåƒæ ‡ç­¾ç­–ç•¥

### Builder é•œåƒæ ‡ç­¾

- `latest`ï¼šä¸»åˆ†æ”¯çš„æœ€æ–°ç‰ˆæœ¬
- `builder-{version}`ï¼šè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
- `{branch}-builder`ï¼šåˆ†æ”¯æ„å»ºæ ‡ç­¾

### åº”ç”¨é•œåƒæ ‡ç­¾

- `latest`ï¼šä¸»åˆ†æ”¯çš„æœ€æ–°ç‰ˆæœ¬
- `{version}`ï¼šè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
- `{branch}`ï¼šåˆ†æ”¯æ„å»ºæ ‡ç­¾

## æ³¨æ„äº‹é¡¹

- Builder é•œåƒä½¿ç”¨ `--target builder` åªæ„å»ºç¬¬ä¸€é˜¶æ®µ
- åº”ç”¨é•œåƒæ„å»ºæ—¶ä¼šè‡ªåŠ¨æ‹‰å–æœ€æ–°çš„ builder é•œåƒ
- å¦‚æœ builder é•œåƒä¸å­˜åœ¨ï¼Œåº”ç”¨é•œåƒæ„å»ºä¼šå¤±è´¥ï¼Œéœ€è¦å…ˆæ„å»º builder é•œåƒ
- å»ºè®®åœ¨ä¿®æ”¹ `pyproject.toml` æˆ– `uv.lock` åï¼Œå…ˆç­‰å¾… builder é•œåƒæ„å»ºå®Œæˆå†æ¨é€å…¶ä»–ä»£ç å˜æ›´
- æœ¬åœ°æµ‹è¯•æ—¶ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ `--target builder` å‚æ•°æ„å»º builder é•œåƒ

## æ•…éšœæ’é™¤

### pyaudio ç¼–è¯‘å¤±è´¥

å¦‚æœé‡åˆ°ç±»ä¼¼ `error: command 'gcc' failed` çš„é”™è¯¯ï¼š

1. æ£€æŸ¥ builder é•œåƒæ˜¯å¦æ­£ç¡®æ„å»ºï¼ˆä½¿ç”¨ `--target builder`ï¼‰
2. ç¡®è®¤ builder é•œåƒåŒ…å«å¿…è¦çš„ç¼–è¯‘å·¥å…·å’Œå¼€å‘åº“
3. éªŒè¯åº”ç”¨é•œåƒæ˜¯å¦æ­£ç¡®ä» builder å¤åˆ¶è™šæ‹Ÿç¯å¢ƒ

### é•œåƒæ‹‰å–å¤±è´¥

å¦‚æœåº”ç”¨æ„å»ºæ—¶æ— æ³•æ‹‰å– builder é•œåƒï¼š

1. æ£€æŸ¥ builder é•œåƒæ˜¯å¦å·²æ¨é€åˆ°æ³¨å†Œè¡¨
2. ç¡®è®¤é•œåƒåç§°å’Œæ ‡ç­¾æ˜¯å¦æ­£ç¡®
3. éªŒè¯è®¿é—®æƒé™æ˜¯å¦è¶³å¤Ÿ
